# 四轮全向轮底盘控制系统说明

## 一、项目简介

本项目为基于STM32的四轮全向轮底盘运动控制系统，支持全向移动、原地旋转、定角度转动等多种运动模式。系统采用CAN总线与M3508电机通信，内置多环PID调节，支持串口在线参数调试。

---

## 二、主要功能

- **全向运动控制**：支持任意方向直线、平移、原地旋转、定角度旋转等复合运动。
- **多环PID调节**：速度环、差速补偿环、角度环均可独立调参，提升运动精度与稳定性。
- **CAN通信**：高效滤波，仅接收0x201~0x204反馈，实时下发4路电机电流指令。
- **参数结构化与在线调参**：所有PID参数结构体化，支持串口命令动态调整。
- **运动学分解**：内置CORDIC算法，精确实现任意角度分解与合成。

---

## 三、代码结构

```
wheel_chassis/
 ├── wheel_chassis/Inc/
 │    ├── wheelchassis.h      # 底盘运动控制主接口与结构体定义
 │    ├── ParamsUsart.h       # 串口调参接口
 │    └── cordic.h            # CORDIC接口
 ├── wheel_chassis/Src/
 │    ├── wheelchassis.c      # 底盘运动主流程与控制实现
 │    ├── ParamsUsart.c       # 串口调参实现
 │    └── cordic.c            # CORDIC算法实现
 ├── Drivers/                 # STM32 HAL、CMSIS等底层驱动
 ├── Inc/、Src/               # 工程全局头文件与源文件
 └── ...                      # 其他CubeMX、CMake等工程文件
```

---

## 四、核心数据结构与接口

### 1. 运动控制结构体

```c
typedef enum 
{ 
    Wait, 
    Linear, 
    Turn1, 
    Turn2 
} MotionState;

typedef struct {
    MotionState state;         // 当前运动状态
    float RelativeAngle;       // 直线运动方向角（度）
    float MovementSpeed;       // 直线速度（r/s）
    float MovementDisplacement;// 直线位移（r）
    float TurnSpeed;           // 原地旋转速度（r/s）
    float TurnAngle;           // 原地旋转角度（度）
    uint8_t TurnAngleChange_Flag; // 角度环重置标志
} MotionControl;
```

### 2. PID参数结构体

```c
typedef struct {
    float Kp, Ki, Kd;
    float IntegralLimit; // 积分限幅
    float OutputLimit;   // 输出限幅
} PID_Params;
```

### 3. 主要接口函数

- `void wheelChassis_Init(void);`  
  底盘模块初始化（CAN配置、PID参数、物理参数等）。

- `void wheelChassis_Linear(float speed, float angle);`  
  设置直线/平移运动，任意方向。

- `void wheelChassis_Turn1(float speed);`  
  设置原地旋转（速度环控制）。

- `void wheelChassis_Turn2(float angle);`  
  设置原地定角度旋转（角度环+速度环串级）。

- `void wheelChassis_Stop(void);`  
  紧急停止，进入待机。

- `void Uart_Init(void);`  
  串口调参初始化。

- `void Uart_ProcessCommand(void);`  
  串口命令解析与参数调整。

---

## 五、运动学与控制流程

### 1. 运动主流程

- **定时中断回调**（如1ms周期）：
  1. 采集4路电机反馈（角度、速度、电流、温度）。
  2. 调用 `wheelChassis_MotionControl()`，根据全局运动状态分配目标速度。
  3. 速度环PID输出4路电流，差速补偿提升直线/平移精度。
  4. 通过CAN下发电流指令。

- **运动模式切换**：  
  通过 `wheelChassis_Linear`、`wheelChassis_Turn1`、`wheelChassis_Turn2` 等接口随时切换运动状态。

### 2. 运动控制

- 直线/平移运动：  
  目标速度按相对角度分解为各轮分量，CORDIC算法实现高效三角函数计算。

- 原地旋转：  
  四轮目标速度相同，方向一致，实现底盘自转。

- 定角度旋转：  
  角度环PID累计当前角度，输出期望自转速度，速度环闭环控制。

- 差速补偿：  
  对角轮速度差闭环，提升直线和平移一致性。

---

## 六、PID参数调试

- **参数结构体全局可见**，支持串口命令动态调整。
- 串口调参命令示例（通过串口助手发送）：
  - `set sp_p 1.5`  // 设置速度环Kp
  - `set dp_i 0.1`  // 设置差速环Ki
  - `set ap_ol 20`  // 设置角度环输出限幅
  - `get sp_p`      // 查询速度环Kp
- 支持所有PID参数的查询与修改，调参无需重启。

---

## 七、串口调参与波形功能详解

本系统支持通过串口助手发送命令，**实时调整底盘控制参数和运动状态**。

### 1. 串口调参命令说明

#### 命令格式

- **参数设置/查询**
  - `set <参数名> <值>`  // 设置参数
  - `get <参数名>`     // 查询参数

- **运动控制**
  - `move linear <速度> <角度>` // 直线/平移运动，单位 r/s、度
  - `move turn1 <速度>`     // 原地旋转，单位 r/s
  - `move turn2 <角度>`     // 定角度旋转，单位 度
  - `move stop`         // 紧急停止

- **帮助**
  - `help`           // 显示所有支持命令

#### 参数名一览

| 参数名   | 说明           | 适用环节   |
|----------|----------------|------------|
| sp_p     | 速度环Kp       | 速度环     |
| sp_i     | 速度环Ki       | 速度环     |
| sp_d     | 速度环Kd       | 速度环     |
| sp_il    | 速度环积分限幅 | 速度环     |
| sp_ol    | 速度环输出限幅 | 速度环     |
| dp_p     | 差速环Kp       | 差速补偿环 |
| dp_i     | 差速环Ki       | 差速补偿环 |
| dp_d     | 差速环Kd       | 差速补偿环 |
| dp_il    | 差速环积分限幅 | 差速补偿环 |
| dp_ol    | 差速环输出限幅 | 差速补偿环 |
| ap_p     | 角度环Kp       | 角度环     |
| ap_i     | 角度环Ki       | 角度环     |
| ap_d     | 角度环Kd       | 角度环     |
| ap_il    | 角度环积分限幅 | 角度环     |
| ap_ol    | 角度环输出限幅 | 角度环     |

#### 命令示例

- 设置速度环Kp为1.5：  
  `set sp_p 1.5`
- 查询差速环Ki：  
  `get dp_i`
- 让底盘以1.0r/s速度，30度方向直线运动：  
  `move linear 1.0 30`
- 让底盘以2.0r/s原地旋转：  
  `move turn1 2.0`
- 让底盘原地旋转90度：  
  `move turn2 90`
- 停止底盘运动：  
  `move stop`
- 查看所有命令帮助：  
  `help`

---

### 2. 串口波形数据输出与VOFA+可视化

系统支持通过串口实时输出电机速度等数据，便于上位机（如VOFA+）进行波形显示和调试。

#### 数据格式

- 默认采用**逗号分隔的ASCII格式**，每周期输出一行，内容为：
  ```
  <实际速度1>,<实际速度2>,<实际速度3>,<实际速度4>,<期望速度1>,<期望速度2>,<期望速度3>,<期望速度4>
  ```
  例如：
  ```
  12.34,11.98,12.01,12.10,13.00,13.00,13.00,13.00
  ```

#### VOFA+配置方法

1. **串口参数**：  
   - 波特率：115200
   - 数据位：8
   - 停止位：1
   - 校验位：无

2. **协议选择**：  
   - **FireWater协议**

3. **通道映射**：  
   - 通道1~4：实际速度
   - 通道5~8：期望速度

4. **显示效果**：  
   - 可实时观察各轮速度闭环效果、调参响应、运动平稳性等。

---



## 九、常见问题与调试建议

- **运动异常/跑偏**：优先检查差速补偿环参数。
- **响应慢/振荡**：调整速度环PID参数，适当减小积分限幅。
- **定角度不准**：检查角度环PID参数与底盘物理参数（半径、轮径）。
- **串口调参无效**：确认串口波特率、命令格式及硬件连接。
